from django.http import HttpResponse, Http404
from django.core import serializers
import re, json, xml
from getdata.models import record_search
from django.template import Context, RequestContext
LANG_DEFAULT = "json"
def validation(request):
	lang = LANG_DEFAULT
	if request.method == "GET":
		pattern_validation1 = re.compile("^.*\.$")
		##Capture parameters
		type_of_record = request.GET.get('class')
		domain = request.GET.get('name')
		data = request.GET.get('data')
		ttl = request.GET.get('ttl')

		if request.GET.get('lang'): 
			lang = request.GET.get('lang')
		params = {"domain": domain, "record": type_of_record, "record_points_to": data, "ttl": ttl }
		params = dict((key, value) for key, value in params.iteritems() if value)
		if  domain and pattern_validation1.search(domain):
			return HttpResponse("Domain name should not end with a trailing dot '.'", status=400)
		else:
			response = search(params, lang)
			if response:
				return HttpResponse(search(params, lang))
			else:
				return HttpResponse("Record not found", status=404)
	else:
		return HttpResponse("Request method should be GET", status=405)
def date_handler(obj):
	return obj.isoformat() if hasattr(obj, 'isoformat') else obj

def search(params, lang):
	filter_kwargs = {}
	for key,value in params.iteritems():
		filter_kwargs[key + "__startswith"] = value
	query_count = record_search.objects.filter(**filter_kwargs).only("domain", "record", "record_points_to", "priority_mx", "ttl", "generated_on").count()
	query_data = record_search.objects.filter(**filter_kwargs).only("domain", "record", "record_points_to", "priority_mx", "ttl", "generated_on")
	#query_data_length = ', {"Total records": ' +	str(len(query_data.values())) + '}]';
	query_data_length = {"records_returned":	len(query_data.values()), "total_records": query_count}
	#query_data_length = {"records_returned":	len(query_data.values())}
	if query_data:
		#data = serializers.serialize(lang, query_data)
		data = list(query_data.values())
		data.insert(0, query_data_length)
		#data = json.dumps(list(query_data.values()), default=date_handler)
		data = json.dumps(data, default=date_handler)
	else:
		return query_data
#	data = re.sub("\]$", query_data_length, data)
#	return re.sub('\"model\"\:\s+?\"getdata\.record_search\"\,', "", data) 
	return data

